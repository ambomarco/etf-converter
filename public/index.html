<!DOCTYPE html>
<html lang="it">
<head>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script type="text/javascript" src="app.js"></script>
		<link rel="stylesheet" href="app.css" type="text/css" />

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ETF EUR Converter</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h1 { text-align:center; }
#addForm { margin-bottom: 20px; }
label { margin-right: 10px; }
input, select, button { padding: 5px; margin-right: 10px; }
.item { background: white; margin-bottom: 15px; padding: 10px; border-radius: 5px; }
.item h3 { margin: 0 0 10px 0; }
.remove-btn { background: #c00; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>ETF & Valuta Converter in EUR</h1>
<form id="addForm">
<label for="symbol">Ticker:</label>
<input type="text" id="symbol" required placeholder="es. VOO" />
<label for="currency">Valuta:</label>
<select id="currency" required>
<option value="USD">USD</option>
<option value="EUR">EUR</option>
<option value="GBP">GBP</option>
<option value="CHF">CHF</option>
<option value="JPY">JPY</option>
</select>
<button type="submit">Aggiungi</button>
</form>
<div id="items"></div>

<h2>Grafico Storico</h2>
<div style="width: 80%; margin: 20px auto;">
<canvas id="priceChart"></canvas>
</div>

<script>
const addForm = document.getElementById('addForm');
const itemsDiv = document.getElementById('items');
const ctx = document.getElementById('priceChart').getContext('2d');
let myChart;

async function fetchPrices() {
const res = await fetch('/api/prices');
const data = await res.json();
renderItems(data);
}

function renderItems(data) {
itemsDiv.innerHTML = '';
data.forEach(item => {
const div = document.createElement('div');
div.className = 'item';

let html = `<h3>${item.symbol} (${item.currency})</h3>`;
html += `<p>Prezzo: ${item.price !== null ? item.price.toFixed(4) : 'N/A'}</p>`;
html += `<p>Valore in EUR: ${item.convertedEUR !== null ? item.convertedEUR.toFixed(4) : 'N/A'}</p>`;
html += `<button class="remove-btn" data-symbol="${item.symbol}">Rimuovi</button>`;
html += `<button class="chart-btn" data-symbol="${item.symbol}">Mostra Grafico</button>`;

div.innerHTML = html;
itemsDiv.appendChild(div);
});

document.querySelectorAll('.remove-btn').forEach(btn => {
btn.onclick = async () => {
const sym = btn.getAttribute('data-symbol');
if (confirm(`Rimuovere ${sym}?`)) {
await fetch('/api/remove', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ symbol: sym })
});
fetchPrices();
}
};
});

// Aggiungi l'evento al nuovo pulsante per mostrare il grafico
document.querySelectorAll('.chart-btn').forEach(btn => {
btn.onclick = async () => {
const symbol = btn.getAttribute('data-symbol');
await fetchAndDrawChart(symbol);
};
});
}

// NUOVA FUNZIONE: per recuperare i dati storici e disegnare il grafico
async function fetchAndDrawChart(symbol) {
const res = await fetch(`/api/history/${symbol}`);
const data = await res.json();

if (data.status === 'ok') {
const dates = data.values.map(val => new Date(val.datetime).toLocaleDateString());
const prices = data.values.map(val => parseFloat(val.close));

if (myChart) {
myChart.destroy(); // Distrugge il grafico precedente se esiste
}

myChart = new Chart(ctx, {
type: 'line',
data: {
labels: dates,
datasets: [{
label: `Prezzo di ${symbol}`,
data: prices,
borderColor: 'rgb(75, 192, 192)',
tension: 0.1
}]
},
options: {
responsive: true,
scales: {
y: {
beginAtZero: false
}
}
}
});
} else {
alert('Impossibile caricare i dati storici per il simbolo.');
}
}

addForm.onsubmit = async (e) => {
e.preventDefault();
const symbol = document.getElementById('symbol').value.trim().toUpperCase();
const currency = document.getElementById('currency').value;
if (!symbol) return alert('Inserisci un ticker valido');
await fetch('/api/add', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ symbol, currency })
});
addForm.reset();
fetchPrices();
};

fetchPrices();
setInterval(fetchPrices, 10000);
</script>
</body>
</html>
